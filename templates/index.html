<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Personales</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* --- ESTILOS BASE (MODO CLARO) --- */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            max-width: 1100px; margin: 0 auto; padding: 20px; 
            background-color: #f8fafc; color: #1e293b; 
            transition: background-color 0.3s, color 0.3s; 
        }

        /* --- CABECERA --- */
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; flex-wrap: wrap; gap: 20px; }
        .header-actions { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        h1 { margin: 0; color: #0f172a; font-weight: 700; letter-spacing: -0.5px; font-size: 1.8rem; }

        /* --- BOTONES --- */
        .btn-header { text-decoration: none; padding: 10px 16px; border-radius: 10px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; display: flex; align-items: center; gap: 8px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-export { background-color: #10b981; } .btn-export:hover { background-color: #059669; }
        .btn-logout { background-color: #ef4444; } .btn-logout:hover { background-color: #dc2626; }
        .btn-ver-todo { background-color: #f1f5f9; color: #475569; box-shadow: none; border: 1px solid #e2e8f0; } .btn-ver-todo:hover { background-color: #e2e8f0; color: #1e293b; }
        .theme-toggle { background-color: #f1f5f9; border: 1px solid #e2e8f0; cursor: pointer; padding: 10px; border-radius: 50%; color: #64748b; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .theme-toggle:hover { background-color: #e2e8f0; color: #0f172a; transform: scale(1.05); }
        button[type="submit"] { width: auto; padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600; font-size: 1rem; cursor: pointer; color: white; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); transition: all 0.2s ease; }
        button[type="submit"]:hover { transform: translateY(-2px); box-shadow: 0 6px 10px -1px rgba(37, 99, 235, 0.3); }

        /* --- TARJETAS Y CONTENEDORES --- */
        .stat-card, .form-container, .chart-section, .table-responsive, .budget-form, .budget-list { 
            background: #ffffff; border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); 
            border: 1px solid #f1f5f9; padding: 25px; margin-bottom: 30px; 
            transition: all 0.3s ease; 
        }

        /* --- DASHBOARD (KPIs) --- */
        .dashboard-grid { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { flex: 1; padding: 20px; display: flex; flex-direction: column; }
        .stat-title { font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-bottom: 8px; }
        .stat-value { font-size: 2.2rem; font-weight: 700; color: #0f172a; line-height: 1.2; }
        .stat-card:nth-child(1) { background: linear-gradient(to bottom right, #ffffff, #ecfdf5); border-color: #a7f3d0; } /* Ingresos (verde) */
        .stat-card:nth-child(2) { background: linear-gradient(to bottom right, #ffffff, #eff6ff); border-color: #bfdbfe; } /* Balance (azul) */
        .stat-card:nth-child(3) { background: linear-gradient(to bottom right, #ffffff, #fef2f2); border-color: #fecaca; } /* Gastos (rojo) */
        .main-balance .stat-value { color: #1e40af; }
        .text-success { color: #059669; } .text-danger { color: #dc2626; }

        /* --- FORMULARIOS E INPUTS --- */
        .section-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; color: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        .form-row { display: flex; gap: 15px; flex-wrap: wrap; }
        input, select, .filtro-mes { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; transition: all 0.2s ease; background-color: #fff; color: #0f172a; font-family: inherit; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .form-row input, .form-row select { flex: 1; min-width: 140px; width: auto; }

        /* --- GR츼FICOS --- */
        .charts-row { display: flex; gap: 25px; margin-bottom: 40px; flex-wrap: wrap; }
        .charts-row .chart-section { flex: 1; min-width: 350px; margin-bottom: 0; }
        .chart-container { position: relative; width: 100%; height: 300px; } 

        /* --- PRESUPUESTOS --- */
        .budget-item { margin-bottom: 25px; }
        .budget-info { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; color: #475569; }
        .budget-bar-bg { height: 12px; background-color: #f1f5f9; border-radius: 6px; overflow: hidden; }
        .budget-bar-fill { height: 100%; border-radius: 6px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .bg-blue { background-color: #3b82f6; } .bg-red { background-color: #ef4444; } .bg-warning { background-color: #f59e0b; }

        /* --- TABLA --- */
        .table-responsive { padding: 0; overflow-x: auto; border-radius: 16px; }
        table { width: 100%; border-collapse: collapse; text-align: left; min-width: 700px; }
        th { background-color: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1.2px; padding: 16px 24px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 16px 24px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; color: #334155; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8fafc; }
        .monto { font-family: 'Inter', monospace; font-weight: 700; letter-spacing: -0.5px; }
        .fecha { color: #94a3b8; font-size: 0.9rem; }
        .badge { display: inline-block; padding: 6px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; background-color: #f1f5f9; color: #475569; }
        .btn-delete-js { color: #cbd5e0; transition: color 0.2s; padding: 5px; } .btn-delete-js:hover { color: #ef4444; }
        .fade-out { animation: fadeOut 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-20px); } }

        /* --- MODO OSCURO REFINADO --- */
        body.dark-mode { background-color: #0B1120; color: #E2E8F0; }
        body.dark-mode .header-flex { border-bottom-color: #1E293B; }
        body.dark-mode h1 { color: #F8FAFC; }
        body.dark-mode .stat-card, body.dark-mode .form-container, body.dark-mode .chart-section, body.dark-mode .table-responsive, body.dark-mode .budget-form, body.dark-mode .budget-list {
            background-color: #111827; border-color: #1F2937; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .section-title { color: #F8FAFC; }
        body.dark-mode input, body.dark-mode select, body.dark-mode .filtro-mes {
            background-color: #1F2937; border-color: #374151; color: #F8FAFC;
        }
        body.dark-mode input:focus, body.dark-mode select:focus { border-color: #60A5FA; }
        body.dark-mode th { background-color: #1F2937; border-bottom-color: #374151; color: #94A3B8; }
        body.dark-mode td { border-bottom-color: #1F2937; color: #E2E8F0; }
        body.dark-mode tr:hover { background-color: #171F2E; }
        body.dark-mode .badge { background-color: #1F2937; color: #CBD5E1; }
        body.dark-mode .theme-toggle { background-color: #1F2937; border-color: #374151; color: #FBBF24; }
        body.dark-mode .theme-toggle:hover { background-color: #374151; }
        body.dark-mode .btn-ver-todo { background-color: #1F2937; color: #E2E8F0; border-color: #374151; }
        body.dark-mode .stat-title, body.dark-mode .fecha, body.dark-mode .budget-info { color: #94A3B8; }
        body.dark-mode .budget-bar-bg { background-color: #1F2937; }
        body.dark-mode .stat-card:nth-child(1) { background: linear-gradient(145deg, #111827, #064e3b); border-color: #059669; }
        body.dark-mode .stat-card:nth-child(2) { background: linear-gradient(145deg, #111827, #1e3a8a); border-color: #2563eb; }
        body.dark-mode .stat-card:nth-child(3) { background: linear-gradient(145deg, #111827, #7f1d1d); border-color: #dc2626; }
        body.dark-mode .main-balance .stat-value { color: #F8FAFC; }
        body.dark-mode .text-success { color: #34D399; } body.dark-mode .text-danger { color: #F87171; }
        body.dark-mode canvas { filter: brightness(0.9); }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .dashboard-grid, .charts-row, .budget-section, .header-flex { flex-direction: column; gap: 15px; }
            .header-flex { align-items: flex-start; }
            .header-actions { width: 100%; justify-content: space-between; }
            .form-row { flex-direction: column; }
            .form-row input, .form-row select, button[type="submit"] { width: 100%; }
            .chart-container { height: 250px; }
        }
    </style>
</head>
<body>
    <div class="header-flex">
        <h1>Hola, {{ username }} 游녦</h1>
        <div class="header-actions">
            <form action="/" method="GET" style="margin: 0;">
                 <input type="month" name="mes" class="filtro-mes" value="{{ mes_seleccionado if mes_seleccionado else '' }}" onchange="this.form.submit()">
            </form>
            {% if mes_seleccionado %}
            <a href="/" class="btn-header btn-ver-todo">Ver Todo</a>
            {% endif %}
            <a href="/exportar" class="btn-header btn-export">游늯 Exportar</a>
            <a href="/logout" class="btn-header btn-logout">Cerrar Sesi칩n</a>
            <button id="darkModeToggle" class="theme-toggle" title="Cambiar tema">
                <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            </button>
        </div>
    </div>
    
    <div class="dashboard-grid">
        <div class="stat-card">
            <div class="stat-title">Ingresos {{ titulo_periodo }}</div>
            <div class="stat-value text-success">+${{ ingresos }}</div>
        </div>
        <div class="stat-card main-balance">
            <div class="stat-title">Balance {{ titulo_periodo }}</div>
            <div class="stat-value">${{ balance }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Gastos {{ titulo_periodo }}</div>
            <div class="stat-value text-danger">-${{ gastos }}</div>
        </div>
    </div>

    <div class="form-container">
        <div class="section-title">Registrar Movimiento</div>
        <form action="/" method="POST" class="form-row">
            <input type="date" name="fecha" value="{{ fecha_hoy }}" required>
            <select name="tipo" required>
                <option value="gasto">Gasto</option>
                <option value="ingreso">Ingreso</option>
            </select>
            <select name="categoria" required>
                <option value="" disabled selected>Categor칤a</option>
                <option value="Vivienda">Vivienda</option>
                <option value="Alimentaci칩n">Alimentaci칩n</option>
                <option value="Transporte">Transporte</option>
                <option value="Ocio">Ocio</option>
                <option value="Servicios">Servicios</option>
                <option value="Salud">Salud</option>
                <option value="N칩mina">N칩mina</option>
                <option value="Otros">Otros</option>
            </select>
            <input type="text" name="descripcion" placeholder="Descripci칩n" required style="flex: 2;">
            <input type="number" name="monto" step="0.01" placeholder="Monto 0.00" required>
            <button type="submit">Guardar</button>
        </form>
    </div>

    {% if lista_movimientos|length > 0 %}
    <div class="charts-row">
        <div class="chart-section">
            <div class="section-title" style="justify-content: center;">Gastos por Categor칤a</div>
            <div class="chart-container">
                {% if categorias_data|length > 0 %}
                    <canvas id="gastosChart"></canvas>
                {% else %}
                    <p style="text-align: center; opacity: 0.6; padding-top: 130px;">Sin gastos este periodo</p>
                {% endif %}
            </div>
        </div>
        <div class="chart-section">
            <div class="section-title" style="justify-content: center;">Tendencia Diaria</div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="budget-section">
        <div class="budget-form">
            <div class="section-title">Definir Meta Mensual</div>
            <form action="/guardar_presupuesto" method="POST">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; opacity: 0.8;">Categor칤a</label>
                    <select name="categoria_presupuesto" required>
                        <option value="Alimentaci칩n">Alimentaci칩n</option>
                        <option value="Vivienda">Vivienda</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Ocio">Ocio</option>
                        <option value="Servicios">Servicios</option>
                        <option value="Salud">Salud</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; opacity: 0.8;">L칤mite Mensual ($)</label>
                    <input type="number" name="monto_limite" required placeholder="Ej. 2000">
                </div>
                <button type="submit" style="width: 100%;">Guardar Meta</button>
            </form>
        </div>

        <div class="budget-list">
            <div class="section-title">
                Progreso de este Mes
                <span style="font-size: 0.85rem; opacity: 0.7; font-weight: normal;">(Reinicia el d칤a 1)</span>
            </div>
            {% if estado_presupuestos|length == 0 %}
                <div style="text-align: center; opacity: 0.6; padding: 30px;">
                    No has definido ninguna meta todav칤a.
                </div>
            {% else %}
                <div style="max-height: 300px; overflow-y: auto; padding-right: 10px;">
                {% for item in estado_presupuestos %}
                <div class="budget-item">
                    <div class="budget-info">
                        <span style="font-weight: 600;">{{ item.categoria }}</span>
                        <span>${{ item.gastado }} / <strong>${{ item.limite }}</strong></span>
                    </div>
                    <div class="budget-bar-bg">
                        <div class="budget-bar-fill {{ 'bg-red' if item.excedido else ('bg-warning' if item.porcentaje > 80 else 'bg-blue') }}" 
                             style="width: {{ item.porcentaje }}%;"></div>
                    </div>
                </div>
                {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Descripci칩n</th>
                    <th>Categor칤a</th>
                    <th>Monto</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% if lista_movimientos|length == 0 %}
                <tr>
                    <td colspan="5" style="text-align: center; opacity: 0.6; padding: 40px;">
                        No hay movimientos registrados en este periodo.
                    </td>
                </tr>
                {% else %}
                    {% for mov in lista_movimientos %}
                    <tr>
                        <td class="fecha">{{ mov.fecha }}</td>
                        <td style="font-weight: 500;">{{ mov.descripcion }}</td>
                        <td><span class="badge">{{ mov.categoria }}</span></td>
                        <td class="monto {{ 'text-success' if mov.tipo == 'ingreso' else 'text-danger' }}">
                            {{ '+' if mov.tipo == 'ingreso' else '-' }} ${{ mov.monto }}
                        </td>
                        <td style="text-align: right; white-space: nowrap;">
                            <a href="/editar/{{ mov.id }}" style="margin-right: 15px; text-decoration: none; color: #3b82f6; font-weight: 600; font-size: 0.9rem;">Editar</a>
                            <button class="btn-delete-js" data-id="{{ mov.id }}" style="background: none; border: none; cursor: pointer; padding: 5px; color: #94a3b8; transition: color 0.2s; vertical-align: middle;" title="Eliminar">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        function mostrarToast(mensaje, tipo) {
            let color = "#3b82f6"; if (tipo === "exito") color = "#10b981"; if (tipo === "error" || tipo === "borrado") color = "#ef4444";
            Toastify({ text: mensaje, duration: 3000, gravity: "top", position: "right", stopOnFocus: true, style: { background: color, borderRadius: "12px", boxShadow: "0 4px 12px rgba(0,0,0,0.15)", fontWeight: "600", padding: "12px 24px" } }).showToast();
        }
        function getChartColors() {
            const isDark = document.body.classList.contains('dark-mode');
            return { fontColor: isDark ? '#94a3b8' : '#64748b', gridColor: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)', borderColor: isDark ? '#334155' : '#e2e8f0' };
        }
        {% for category, message in get_flashed_messages(with_categories=true) %} mostrarToast("{{ message }}", "{{ category }}"); {% endfor %}

        const toggleButton = document.getElementById('darkModeToggle');
        const iconSun = document.querySelector('.icon-sun'); const iconMoon = document.querySelector('.icon-moon');
        function updateIcons(isDark) { iconSun.style.display = isDark ? 'none' : 'block'; iconMoon.style.display = isDark ? 'block' : 'none'; }
        if (localStorage.getItem('darkMode') === 'enabled') { document.body.classList.add('dark-mode'); updateIcons(true); }
        toggleButton.addEventListener('click', () => { document.body.classList.toggle('dark-mode'); const isDark = document.body.classList.contains('dark-mode'); localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled'); updateIcons(isDark); setTimeout(() => window.location.reload(), 50); });

        const chartColors = getChartColors();
        const categoriasLabels = {{ categorias_labels | tojson }}; const categoriasData = {{ categorias_data | tojson }};
        if (categoriasData.length > 0) { new Chart(document.getElementById('gastosChart'), { type: 'doughnut', data: { labels: categoriasLabels, datasets: [{ data: categoriasData, backgroundColor: [ '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6b7280' ], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, color: chartColors.fontColor, font: { family: 'Inter' } } } }, layout: { padding: { bottom: 10 } }, cutout: '75%' } }); }
        const trendLabels = {{ trend_labels | tojson }}; const trendIngresos = {{ trend_ingresos | tojson }}; const trendGastos = {{ trend_gastos | tojson }};
        if (trendLabels.length > 0) { new Chart(document.getElementById('trendChart'), { type: 'line', data: { labels: trendLabels, datasets: [ { label: 'Ingresos', data: trendIngresos, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.3, fill: true, pointRadius: 0, pointHitRadius: 20 }, { label: 'Gastos', data: trendGastos, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.3, fill: true, pointRadius: 0, pointHitRadius: 20 } ] }, options: { responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' }, plugins: { legend: { position: 'bottom', labels: { color: chartColors.fontColor, font: { family: 'Inter' }, usePointStyle: true, padding: 20 } } }, scales: { y: { beginAtZero: true, grid: { color: chartColors.gridColor, borderColor: chartColors.borderColor }, ticks: { color: chartColors.fontColor, font: { family: 'Inter' } } }, x: { grid: { display: false, borderColor: chartColors.borderColor }, ticks: { color: chartColors.fontColor, font: { family: 'Inter' }, maxTicksLimit: 8 } } } } }); }

        // --- ELIMINACI칍N CON SWEETALERT2 ---
        document.querySelectorAll('.btn-delete-js').forEach(btn => {
            btn.addEventListener('click', () => {
                const isDark = document.body.classList.contains('dark-mode');
                Swal.fire({
                    title: '쮼st치s seguro?',
                    text: "No podr치s revertir esto.",
                    icon: 'info', // Cambiado de 'warning' a 'info'
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444', // Rojo
                    cancelButtonColor: '#3b82f6', // Azul
                    confirmButtonText: 'S칤, eliminar',
                    cancelButtonText: 'Cancelar',
                    background: isDark ? '#1F2937' : '#fff', // Fondo m치s claro en modo oscuro
                    color: isDark ? '#F8FAFC' : '#1e293b' // Color del texto
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const res = await fetch(`/eliminar/${btn.dataset.id}`, { method: 'POST', headers: {'Accept': 'application/json'} });
                            const data = await res.json();
                            if (res.ok && data.success) {
                                const row = btn.closest('tr'); row.classList.add('fade-out'); setTimeout(() => row.remove(), 400);
                                mostrarToast("Movimiento eliminado", "borrado");
                            } else { mostrarToast("Error: " + (data.message || "Desconocido"), "error"); }
                        } catch (e) { mostrarToast("Error de conexi칩n", "error"); }
                    }
                });
            });
        });
    </script>
</body>
</html>